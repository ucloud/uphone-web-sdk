'use strict';var PeerConnectionClient=function(_0x3a72ad,_0x128d47){this['params_']=_0x3a72ad;this['startTime_']=_0x128d47;this['singalUrl']='https://signal.ugame.ucloud.cn:8001/api/v1/';this['pc_']=new RTCPeerConnection(_0x3a72ad['peerConnectionConfig'],null);if(this['params_']['mediaConstraints']['audio']){this['pc_']['addTransceiver']('audio',{'direction':'recvonly'});this['trace_']('only\x20receive\x20audio.');}if(this['params_']['mediaConstraints']['video']){this['pc_']['addTransceiver']('video',{'direction':'recvonly'});this['trace_']('only\x20receive\x20video.');}this['pc_']['ondatachannel']=this['onDataChannel_']['bind'](this);this['pc_']['onicecandidate']=this['onIceCandidate_']['bind'](this);this['pc_']['ontrack']=this['onRemoteStreamAdded_']['bind'](this);this['pc_']['onremovestream']=this['trace_']['bind'](this,'Remote\x20stream\x20removed.');this['pc_']['oniceconnectionstatechange']=this['onIceConnectionStateChanged_']['bind'](this);this['channel']=null;this['hasRemoteSdp_']=![];this['messageQueue_']=[];this['isInitiator_']=!![];this['started_']=![];this['recivedmessage']={};this['serial_']='';this['cadidateQueue_']=[];this['onerror']=null;this['oniceconnectionstatechange']=null;this['onnewicecandidate']=null;this['onremotestreamadded']=null;this['onchangedefinit']=null;this['onchangestatus']=null;this['onchangeicestatus']=null;this['onresolutionstatus']=null;this['onmessagehandle']=null;this['onchannelstatus']=null;this['trace_']('create\x20peerconnection\x20success.');};PeerConnectionClient['DEFAULT_SDP_OFFER_OPTIONS_']={'offerToReceiveAudio':0x1,'offerToReceiveVideo':0x1,'voiceActivityDetection':![]};PeerConnectionClient['prototype']['startCreateDataChannel']=function(){this['channel']=this['pc_']['createDataChannel']('uCloudGame',{'negotiated':![],'id':0x0,'ordered':![]});this['channel']['onopen']=()=>{this['onchannelstatus'](this['channel']['readyState']);};this['channel']['onerror']=_0x284d96=>{const _0x4f79f5=_0x284d96['error'];this['onchannelstatus']('Data\x20Channel\x20\x27'+channel['protocol']+'\x27\x20error!\x20'+_0x4f79f5['errorDetail']+'\x20-\x20'+_0x4f79f5['message']);};this['channel']['onclose']=()=>{this['onchannelstatus']('close');};};PeerConnectionClient['prototype']['onDataChannel_']=function(_0x3926b1){let _0x3892c1=_0x3926b1['channel'];_0x3892c1['onmessage']=({data:_0x3c54b4})=>{this['onmessagehandle'](_0x3c54b4);};};PeerConnectionClient['prototype']['sendDataMessage']=function(_0x2a1e9d){return new Promise((_0x625a75,_0x121772)=>{if(this['channel']['readyState']=='open'){this['channel']['send'](_0x2a1e9d);_0x625a75({'channelstate':this['channel']['readyState'],'sendstatus':'success','sendmessage':_0x2a1e9d});}else{_0x625a75({'channelstate':this['channel']['readyState'],'sendstatus':'fail','sendmessage':_0x2a1e9d});}});};PeerConnectionClient['prototype']['startAsCaller']=function(_0x430225){if(!this['pc_']){return![];}if(this['started_']){return![];}this['isInitiator_']=!![];this['started_']=!![];this['serial_']=this['generateUUID_']()['substring'](0x5e6bd^0x5e6bd,0x46cc6^0x46cce);this['pc_']['createOffer']()['then'](this['setLocalSdpAndNotify_']['bind'](this))['catch'](this['onError_']['bind'](this,'createOffer'));return!![];};PeerConnectionClient['prototype']['close']=function(){if(!this['pc_']){return;}this['hasRemoteSdp_']=![];this['started_']=![];if(this['channel']!=null){this['channel']['close']();this['channel']=null;}if(this['pc_']!=null){this['pc_']['close']();this['pc_']=null;}this['trace_']('close\x20peerconnection\x20success.');};PeerConnectionClient['prototype']['getPeerConnectionStats']=function(_0x14c1f4){if(!this['pc_']){return;}this['pc_']['getStats'](null)['then'](_0x14c1f4);};PeerConnectionClient['prototype']['forceconnection']=function(){return new Promise((_0x1c8eca,_0x5c3212)=>{this['pc_']['createOffer']()['then'](_0x53617c=>{var _0x1d7f97={'offer':'Request\x20force\x20connection','request_id':this['generateUUID_'](),'phone_id':this['params_']['Id'],'serial':this['generateUUID_']()['substring'](0x976e1^0x976e1,0xaace1^0xaace9)};this['postRequest_'](this['singalUrl']+'send_offer_receive_answer',{..._0x1d7f97})['then'](_0x2d4b57=>{this['analysisAnswer'](JSON['parse'](_0x2d4b57['data']['answer']));const _0x2d686d=JSON['parse'](_0x2d4b57['data']['answer']);_0x1c8eca(_0x2d686d['code']);console['log'](_0x2d4b57);});});});};PeerConnectionClient['prototype']['setLocalSdpAndNotify_']=function(_0x57b35f){this['pc_']['setLocalDescription'](_0x57b35f)['then'](this['trace_']['bind'](this,'Set\x20local\x20description\x20success.'))['catch'](this['onError_']['bind'](this,'setLocalDescription'));var _0x2f9944={'request_id':this['generateUUID_'](),'phone_id':this['params_']['Id'],'offer':_0x57b35f['sdp'],'serial':this['serial_']};this['postRequest_'](this['singalUrl']+'send_offer_receive_answer',{..._0x2f9944})['then'](_0x1f9e6c=>{this['trace_']('send\x20offer\x20description\x20success.');this['trace_']('iceConnectionState:\x20'+this['pc_']['iceConnectionState']);this['trace_'](_0x1f9e6c);if(_0x1f9e6c['code']==(0x82221^0x82221)){this['analysisAnswer'](JSON['parse'](_0x1f9e6c['data']['answer']));}else{var _0x2a6f1c={'code':_0x1f9e6c['code']};this['analysisAnswer'](_0x2a6f1c);this['trace_'](_0x1f9e6c['message_cn']);}})['catch'](_0x33524a=>{});};PeerConnectionClient['prototype']['analysisAnswer']=function(_0x3009fe){if(_0x3009fe['code']){var _0x25dcad=_0x3009fe['code'];switch(_0x25dcad){case 0xca323^0xca721:this['onchangestatus'](_0x25dcad);return;case 0x5e244^0x5e1af:this['onchangestatus'](_0x25dcad);return;case 0x18da1^0x18e51:this['onchangestatus'](_0x25dcad);return;case 0x6ebef^0x6e806:this['onchangestatus'](_0x25dcad);return;case 0x11d2a:this['onchangestatus'](_0x25dcad);return;default:this['onchangestatus'](_0x25dcad);return;}}this['setRemoteSdp_'](_0x3009fe);};PeerConnectionClient['prototype']['setRemoteSdp_']=function(_0x1ad898){this['pc_']['setRemoteDescription'](new RTCSessionDescription(_0x1ad898))['then'](this['onSetRemoteDescriptionSuccess_']['bind'](this))['catch'](this['onError_']['bind'](this,'setRemoteDescription'));};PeerConnectionClient['prototype']['onSetRemoteDescriptionSuccess_']=function(){this['trace_']('Set\x20remote\x20session\x20description\x20success.');this['hasRemoteSdp_']=!![];if(this['cadidateQueue_']['length']>0x0){this['sendCandidates'](this['cadidateQueue_']);}this['getCandidates']();};PeerConnectionClient['prototype']['onIceCandidate_']=function(_0x41a1ce){if(_0x41a1ce['candidate']){if(this['filterIceCandidate_'](_0x41a1ce['candidate'])){let _0x3e7928={'candidate':_0x41a1ce['candidate']['candidate'],'sdp_m_line_index':_0x41a1ce['candidate']['sdpMLineIndex'],'sdp_mid':_0x41a1ce['candidate']['sdpMid']};if(this['hasRemoteSdp_']){this['sendCandidates'](_0x3e7928);}else{this['cadidateQueue_']['push'](_0x3e7928);}}}else{this['trace_']('End\x20of\x20candidates.');}};PeerConnectionClient['prototype']['sendCandidates']=function(_0x2e708e){if(this['pc_']===null||!this['started_']){return;}let _0x5caab6=_0x2e708e;if(!Array['isArray'](_0x2e708e)){_0x5caab6=[_0x2e708e];}var _0x1a8e71={'request_id':this['generateUUID_'](),'phone_id':this['params_']['Id'],'candidates':_0x5caab6,'serial':this['serial_']};this['postRequest_'](this['singalUrl']+'send_candidate',{..._0x1a8e71})['then'](_0x1f229b=>{if(_0x1f229b['code']==0x0){this['trace_']('send\x20candidates\x20success');}});};var candtimer=0x1d1e7^0x1d1e6;PeerConnectionClient['prototype']['getCandidates']=function(){this['postRequest_'](this['singalUrl']+'receive_candidate',{'request_id':this['generateUUID_'](),'phone_id':this['params_']['Id'],'serial':this['serial_']})['then'](_0xa8082d=>{if(_0xa8082d['code']==(0x86b96^0x86b96)){if(_0xa8082d['data']['candidates']['length']!==(0xa947d^0xa947d)){var _0x4e8c5f=_0xa8082d['data']['candidates'];this['trace_']('receive\x20candidates\x20success.');for(let _0x10f49f=0x0;_0x10f49f<_0x4e8c5f['length'];_0x10f49f++){var _0x395090={'sdpMLineIndex':_0x4e8c5f[_0x10f49f]['sdp_m_line_index'],'candidate':_0x4e8c5f[_0x10f49f]['candidate'],'sdpMid':_0x4e8c5f[_0x10f49f]['sdp_mid']};var _0x349e01=new RTCIceCandidate({..._0x395090});if(this['pc_']){this['pc_']['addIceCandidate'](_0x349e01)['then']();}}}if(this['pc_']&&this['pc_']['iceConnectionState']!=='connected'){if(candtimer>=0x14){candtimer=0x4b7c9^0x4b7c9;return;}setTimeout(()=>{if(this['pc_']&&this['started_']){this['getCandidates']();++candtimer;}else{clearTimeout();}},0x64);}else{clearTimeout();}}});};PeerConnectionClient['prototype']['onIceConnectionStateChanged_']=function(){if(!this['pc_']||!this['started_']){return;}this['onchangeicestatus'](this['pc_']['iceConnectionState']);if(this['oniceconnectionstatechange']){this['oniceconnectionstatechange']();}};PeerConnectionClient['prototype']['filterIceCandidate_']=function(_0xc57c4f){var _0x4a605b=_0xc57c4f['candidate'];var _0x4978f7=_0x4a605b['split']('\x20')[0x7];if(_0x4978f7==='host'||_0x4a605b['indexOf']('host')!==-0x1){this['trace_']('drop\x20host\x20type.');return![];}if(_0x4a605b['indexOf']('tcp')!==-(0xb9740^0xb9741)){return![];}if(this['params_']['peerConnectionConfig']['iceTransports']==='relay'&&_0x4978f7!=='relay'){return![];}return!![];};PeerConnectionClient['prototype']['onRemoteStreamAdded_']=function(_0x497d5e){if(_0x497d5e['streams']&&_0x497d5e['streams'][0x0]){this['onremotestreamadded'](_0x497d5e['streams'][0xcba6a^0xcba6a]);}};PeerConnectionClient['prototype']['onError_']=function(_0x44aae0,_0x5a1e56){if(this['onerror']){this['onerror'](_0x44aae0+':\x20'+_0x5a1e56['toString']());}};PeerConnectionClient['prototype']['generateUUID_']=function(){return'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'['replace'](/[xy]/g,function(_0x44b30f){var _0x1b72ca=Math['random']()*0x10|0x0,_0x353c3a=_0x44b30f=='x'?_0x1b72ca:_0x1b72ca&(0x7dc13^0x7dc10)|0xccc44^0xccc4c;return _0x353c3a['toString'](0x75e9a^0x75e8a);});};PeerConnectionClient['prototype']['postRequest_']=function(_0x4c0b2f,_0x5e2fac){return new Promise((_0x5c5e68,_0x27c466)=>{const _0x3a6f81=new XMLHttpRequest();_0x3a6f81['open']('post',_0x4c0b2f);_0x3a6f81['setRequestHeader']('content-type','application/json');_0x3a6f81['send'](JSON['stringify'](_0x5e2fac));_0x3a6f81['onreadystatechange']=function(){if(_0x3a6f81['readyState']===0x4){if(_0x3a6f81['status']===0xc8){_0x5c5e68(JSON['parse'](_0x3a6f81['responseText']));}else{_0x27c466('网络异常:'+_0x3a6f81['statusText']);}}};});};PeerConnectionClient['prototype']['trace_']=function(_0x12d343){if(!this['params_']['debug']){return;}if(_0x12d343[_0x12d343['length']-(0x8c45f^0x8c45e)]==='\x0a'){_0x12d343=_0x12d343['substring'](0x0,_0x12d343['length']-0x1);}if(window['performance']){var _0x362970=(window['performance']['now']()/0x3e8)['toFixed'](0x3);console['log'](_0x362970+':\x20'+_0x12d343);}else{console['log'](_0x12d343);}};export default PeerConnectionClient;